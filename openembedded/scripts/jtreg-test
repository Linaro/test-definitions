#!/bin/bash

# LAVA wrapper for invoking jtreg(1) and accumulating the results.
#
# Copyright (C) 2013, Linaro Limited.
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
#
# Author: Andrew McDermott <andrew.mcdermott@linaro.org>
#

# All options before the '--' are for this script. The remaining are
# for jtreg(1).

test_case=unknown
java_vm=-client
product_home=/usr/lib/jvm/java-8-openjdk

while getopts ":j:o:p:t:" opt; do
    case $opt in
	j)
	    java_vm=$OPTARG
	    ;;
	o)
	    output_dir=$OPTARG
	    ;;
	p)
	    product_home=$OPTARG
	    ;;
	t)
	    test_case=$OPTARG
	    ;;
	\?)
	    echo "Invalid option: -$OPTARG" >&2
	    exit 1
	    ;;
	:)
	    echo "Option -$OPTARG requires an argument." >&2
	    exit 1
	    ;;
    esac
done

shift $((OPTIND-1))

output_dir=/tmp/jtreg/$test_case.$$
rm -rf $output_dir

lava-test-case $test_case --shell		\
    jtreg					\
      -J${java_vm}				\
      -vmoption:${java_vm}			\
      -jdk:"${product_home}"			\
      -w:$output_dir/JTwork			\
      -r:$output_dir/JTreport			\
      "$@"

exit_code=$?

shopt -s globstar
shopt -s nullglob

# By pushd'ing we make the attached filenames in the LAVA dashboard
# much smaller.

mkdir -p $output_dir/JTwork/failed

if [ -d $output_dir/JTreport/text ]; then
    pushd $output_dir/JTreport/text
    for i in *.txt; do
        if [ $i = "summary.txt" ]; then
            grep 'Failed\.' $i > failed.txt
            lava-test-case-attach $test_case failed.txt
            grep 'Passed\.' $i > success.txt
            lava-test-case-attach $test_case success.txt
            sed -i '/Not run\./d' $i
            while read -r line; do
                tc=$(echo $line | awk '{print $1}')
                y=$(dirname $tc)
                z=$(basename $tc .java)
                test_result=$output_dir/JTwork/${y}/${z}.jtr
                if [ -e $test_result ]; then
                    pushd $output_dir/JTwork
                    mkdir -p failed/${y}
                    cp $test_result failed/${y}/${z}.jtr
                    lava-test-case-attach $test_case failed/${y}/${z}.jtr text/plain
                    popd
                fi
            done < failed.txt
        fi
        lava-test-case-attach $test_case $i
    done
    popd
fi

if [ -d $output_dir/JTwork/scratch ]; then
    pushd $output_dir/JTwork/scratch
    for i in hs*.log; do
	lava-test-case-attach $test_case $i text/plain
    done
    popd
fi

if [ -d $output_dir/JTwork ]; then
    pushd $output_dir
    zip --quiet -r JTwork.zip JTwork
    lava-test-case-attach $test_case JTwork.zip
    popd
fi

rm -rf $output_dir

exit $exit_code
