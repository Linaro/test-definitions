metadata:
    name: libhugetlbfs
    format: "Lava-Test-Shell Test Definition 1.0"
    description: "Run through libhugetlbfs next branch tests.
                  Runs through $WORD_SIZE bit libhugetlbfs on target system.
                  The default WORD_SIZE is 64 bit to accomodate 64 bit systems
                  but for 32 bit systems the WORD_SIZE value should be set to
                  32 from the json file passed to the scheduler. One needs to
                  to run with a kernel that supports hugepages.For openembedded,
                  install section needs to be skipped from json file as the test
                  suit comes pre-installed(which is the case with recent OE builds).
                  For Ubuntu, install section is required."
    maintainer:
        - amit.khare@linaro.org
    os:
        - openembedded
        - ubuntu
    scope:
        - functional
    devices:
        - rtsm_ve-armv8
        - panda
        - panda-es
        - arndale
        - vexpress-a9
        - vexpress-tc2
install:
    git-repos:
        - git://git.code.sf.net/p/libhugetlbfs/code
    steps:
        - 'mv code /usr/lib/libhugetlbfs'
        - 'cd /usr/lib/libhugetlbfs'
        - 'git checkout origin/next -b next'
        - 'find . -exec touch {} +'
        - 'make BUILDTYPE=NATIVEONLY'
    deps:
        - git
        - git-core
        - build-essential
        - python
        - python2.7
params:
    WORD_SIZE: 64

run:
    steps:
        - 'echo 200 > /proc/sys/vm/nr_hugepages'
        - 'mkdir /mnt/huge'
        - 'mount -t hugetlbfs hugetlbfs /mnt/huge'
        - 'cd /usr/lib/libhugetlbfs/tests'
        - './run_tests.py -p $((2 * 1024 * 1024)) -b $WORD_SIZE'

parse:
    pattern: '^(?P<test_case_id>.+):\s+(?P<result>FAIL|PASS)'
    fixupdict:
        FAIL: fail
        PASS: pass
