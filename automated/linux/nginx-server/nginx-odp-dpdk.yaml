# NOTE: when calling this test, kernel-headers must have been installed
metadata:
    name: httperf-nginx-ofp-odp-dpdk
    format: Lava-Test-Shell Test Definition 1.0
    description: Server running OFP+ODP+DPDK NGiNX
    environment:
        - lava-test-shell
    maintainer:
        - josep.puigdemont@linaro.org
    os:
        - debian
        - ubuntu
    devices:
        - x86

install:
    deps:
        - bash
        - ethtool
        - pciutils
        - procps
        - sysstat
        - wget

params:
    MAX_CORES: 0
    VLAND_NAME: vlan_one

run:
    steps:
        - wget -O - http://deb.opendataplane.org/odp.key|sudo apt-key add -
        - echo "deb http://deb.opendataplane.org jessie main" > /etc/apt/sources.list.d/odp.list
        - echo "deb http://ftp.debian.org/debian jessie-backports main" > /etc/apt/sources.list.d/backports.list
        - apt-get update
        - apt-get -t jessie-backports install -y libssl1.0.0 libssl-dev
        - sysctl -w vm.nr_hugepages=1024
        - modprobe uio
        - apt-get install -y dpdk-igb-uio-dkms dpdk pciutils
        - export CONFIG_TYPE=odp-dpdk
        - export MAX_CORES VLAND_NAME
        - lava-test-case httperf-nginx-server --shell ./automated/linux/nginx-server/nginx-server.sh
